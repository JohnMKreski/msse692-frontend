<section class="profile" *ngIf="!loading(); else loadingTpl">
  <ng-container *ngIf="user() as u; else notSignedIn">
    <div class="profile__header">
      <img *ngIf="u.photoURL as photo" [src]="photo" alt="User avatar" class="avatar" />
      <div>
        <h1 class="title">{{ (existingProfile()?.displayName) || u.displayName || u.email || 'Your Profile' }}</h1>
        <dl class="overview" aria-label="Account overview">
          <div *ngIf="existingProfile() as p">
            <div><dt>Type</dt><dd>{{ p.profileType }}</dd></div>
            <div><dt>Completed</dt><dd>{{ p.completed }}</dd></div>
            <div><dt>Verified</dt><dd>{{ p.verified }}</dd></div>
          </div>
        </dl>
      </div>
    </div>

    <!-- Profile Info -->
    <section class="profile__data" aria-label="Profile data details">
      <!-- Editable public display name (update only if profile exists) -->
      <div class="inline-form">
        <label class="stack-label">
          <span class="muted">Public display name</span>
          <input type="text" [formControl]="profileName" maxlength="200" placeholder="How your name appears publicly" />
        </label>
        <ng-container *ngIf="existingProfile(); else createCta">
          <button type="button" (click)="saveProfileName()" [disabled]="profileSaving() || profileName.invalid">Save Changes</button>
        </ng-container>
        <ng-template #createCta>
          <a routerLink="/create-profile" class="mat-mdc-unelevated-button mdc-button"><span class="mdc-button__label">Create Your Profile</span></a>
        </ng-template>
        <div *ngIf="profileName.touched && profileName.invalid" class="error">
          <span *ngIf="profileName.errors?.['required']">Display name is required.</span>
          <span *ngIf="profileName.errors?.['minlength']">Must be at least 2 characters.</span>
          <span *ngIf="profileName.errors?.['maxlength']">Must be 200 characters or less.</span>
        </div>
      </div>
      <ng-container *ngIf="existingProfile() as p; else profileSkeleton">
        <dl aria-label="Profile core fields" class="profile-summary">
          <div><dt>Type</dt><dd>{{ p.profileType }}</dd></div>
          <div><dt>Completed</dt><dd>{{ p.completed }}</dd></div>
          <div><dt>Verified</dt><dd>{{ p.verified }}</dd></div>
          <div *ngIf="p.location"><dt>Location</dt><dd>{{ p.location }}</dd></div>
          <div *ngIf="p.description"><dt>Description</dt><dd>{{ p.description }}</dd></div>
        </dl>
        <div *ngIf="(p.socials?.length) || (p.websites?.length)" class="link-grid">
          <div *ngIf="p.socials?.length">
            <h3 class="subhead">Socials</h3>
            <ul class="bulleted">
              <li *ngFor="let s of p.socials">
                <a *ngIf="linkUrl(s) as href" [href]="href" target="_blank" rel="noopener noreferrer">{{ s }}</a>
                <span *ngIf="!linkUrl(s)">{{ s }}</span>
              </li>
            </ul>
          </div>
          <div *ngIf="p.websites?.length">
            <h3 class="subhead">Websites</h3>
            <ul class="bulleted">
              <li *ngFor="let w of p.websites">
                <a *ngIf="linkUrl(w) as href" [href]="href" target="_blank" rel="noopener noreferrer">{{ w }}</a>
                <span *ngIf="!linkUrl(w)">{{ w }}</span>
              </li>
            </ul>
          </div>
        </div>
      </ng-container>
      <ng-template #profileSkeleton>
        <app-loading-skeleton [lines]="2"></app-loading-skeleton>
      </ng-template>
    </section>

    <!-- Request Editor Role -->
    <section class="profile__role-request" aria-label="Request Editor Role">
      <h2 class="section-title">Request Editor Role</h2>
      <div *ngIf="roleReqLoading()"><app-loading-skeleton [lines]="2"></app-loading-skeleton></div>
      <div class="error" *ngIf="roleReqError() as err">{{ err }}</div>
      <ng-container *ngIf="!roleReqLoading()">
        <ng-container *ngIf="latestRoleRequest() as rr; else roleReqForm">
          <div class="current-request">
            <div><strong>ID:</strong> {{ rr.id }}</div>
            <div><strong>Requested Roles:</strong> {{ rr.requestedRoles.join(', ') }}</div>
            <div><strong>Status:</strong> {{ rr.status }}</div>
            <div><strong>Reason:</strong> {{ rr.reason || '—' }}</div>
            <div><strong>Created:</strong> {{ rr.createdAt || '—' }} <span class="muted" *ngIf="rr.createdAt">({{ relTime(rr.createdAt!) }})</span></div>
            <div><strong>Updated:</strong> {{ rr.updatedAt || '—' }} <span class="muted" *ngIf="rr.updatedAt">({{ relTime(rr.updatedAt!) }})</span></div>
            <button type="button" (click)="cancelPendingRoleRequest()" [disabled]="roleReqLoading() || rr.status !== 'Pending'">Cancel</button>
          </div>
        </ng-container>
        <ng-template #roleReqForm>
          <div class="stack-form">
            <label class="stack-label">
              <span class="muted">Reason (optional)</span>
              <textarea [formControl]="roleReason" rows="3" maxlength="500" placeholder="Tell admins why you need editor access"></textarea>
            </label>
            <div class="actions">
              <button type="button" (click)="submitRoleRequest()" [disabled]="roleReqLoading() || roleReason.invalid">Request Editor Role</button>
              <span class="muted" *ngIf="roleReason.invalid">Max 500 characters.</span>
            </div>
          </div>
        </ng-template>
      </ng-container>
      <h3 class="subhead">Request History</h3>
      <div *ngIf="roleHistoryLoading()"><app-loading-skeleton [lines]="2"></app-loading-skeleton></div>
      <div class="error" *ngIf="roleHistoryError() as herr">{{ herr }}</div>
      <ng-container *ngIf="!roleHistoryLoading() && roleHistory() as hist">
        <p class="muted" *ngIf="!hist.length">No prior role requests.</p>
        <ul *ngIf="hist.length" class="bulleted">
          <li *ngFor="let h of hist">#{{ h.id }} • {{ h.status }} • {{ h.createdAt || '—' }}</li>
        </ul>
      </ng-container>
    </section>

    <!-- My Events -->
    <section class="profile__events" aria-label="My events list">
      <h2 class="section-title">My Events ({{ (myEvents() || []).length }})</h2>
      <p class="error" *ngIf="myEventsError() as meErr">{{ meErr }}</p>
      <ng-container *ngIf="myEvents() as my; else myEventsSkeleton">
        <p *ngIf="!my.length && !myEventsError()">You have not created any events yet.</p>
        <ul *ngIf="my.length" class="bulleted">
          <li *ngFor="let e of my">{{ e.eventName || '(untitled event)' }} (ID: {{ e.eventId }})</li>
        </ul>
      </ng-container>
      <ng-template #myEventsSkeleton>
        <app-loading-skeleton [lines]="3"></app-loading-skeleton>
      </ng-template>
    </section>
  </ng-container>

  <ng-template #notSignedIn>
    <p>You’re not signed in. <a routerLink="/login">Go to Login</a></p>
  </ng-template>
</section>

<ng-template #loadingTpl>
  <app-loading-skeleton [avatar]="true" [lines]="3"></app-loading-skeleton>
</ng-template>

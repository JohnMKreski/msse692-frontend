<section class="profile" *ngIf="!loading(); else loadingTpl">
  <ng-container *ngIf="user() as u; else notSignedIn">
    <!-- Overview Header (simplified) -->
    <div class="profile__header" *ngIf="firebaseInfo() as f; else headerSkeleton">
      <img *ngIf="u.photoURL as photo" [src]="photo" alt="User avatar" class="avatar" />
      <div>
        <h1 class="title">{{ (existingProfile()?.displayName) || u.displayName || u.email || 'Your Profile' }}</h1>
        <dl class="overview" aria-label="Account overview">
          <div><dt>UID</dt><dd>{{ f['uid'] }}</dd></div>
          <div *ngIf="u.email"><dt>Email</dt><dd>{{ f['email'] }}</dd></div>
        </dl>
      </div>
    </div>
    <ng-template #headerSkeleton>
      <app-loading-skeleton [avatar]="true" [lines]="2"></app-loading-skeleton>
    </ng-template>

    <!-- Profile Information Section: detailed meta + JSON blocks -->
    <section class="profile__info" aria-label="Profile information details">
      <details>
        <summary><h2 class="section-title">Profile Information</h2></summary>
        <div class="info-grid">
          <dl class="profile-summary" *ngIf="firebaseInfo() as f">
            <div *ngIf="f['metadata']?.creationTime"><dt>Created</dt><dd>{{ f['metadata']?.creationTime }}</dd></div>
            <div *ngIf="f['metadata']?.lastSignInTime"><dt>Last Sign In</dt><dd>{{ f['metadata']?.lastSignInTime }}</dd></div>
            <div *ngIf="effectiveRoles() as er"><dt>Roles</dt><dd>{{ er.join(', ') }}</dd></div>
            <div *ngIf="rolesSource() as rs"><dt>Role Source</dt><dd>{{ rs }}</dd></div>
            <div *ngIf="existingProfile() as p"><dt>Profile Status</dt><dd>{{ p.completed ? 'Completed' : 'Incomplete' }} / {{ p.verified ? 'Verified' : 'Unverified' }}</dd></div>
            <div><dt>Events Created</dt><dd>{{ (myEvents() || []).length }}</dd></div>
          </dl>
        </div>
        <!-- Consolidated full JSON responses -->
        <ng-container *ngIf="firebaseInfo() as f">
          <details>
            <summary>Full Firebase User JSON</summary>
            <pre>{{ f | json }}</pre>
          </details>
        </ng-container>
        <ng-container *ngIf="appUser() as au">
          <details>
            <summary>Full AppUser JSON</summary>
            <pre>{{ au | json }}</pre>
          </details>
        </ng-container>
        <ng-container *ngIf="existingProfile() as p">
          <details>
            <summary>Full Profile JSON</summary>
            <pre>{{ p | json }}</pre>
          </details>
        </ng-container>
      </details>
    </section>

    <!-- Firebase & Token Details -->
    <section class="profile__firebase" aria-label="Authentication and token details">
      <details>
        <summary><h2 class="section-title">Authentication & Token</h2></summary>
        <ng-container *ngIf="claims() as c; else claimsSkeleton">
          <details>
            <summary>Raw Token Claims JSON</summary>
            <pre>{{ c | json }}</pre>
          </details>
        </ng-container>
        <ng-template #claimsSkeleton>
          <app-loading-skeleton [lines]="2"></app-loading-skeleton>
        </ng-template>
        <!--TODO: Remove token from DOM -->
        <div class="token-decode" *ngIf="idTokenHeader() || idTokenPayload()">
          <details>
            <summary>Decoded ID Token (Header & Payload)</summary>
            <h3>Header</h3>
            <pre>{{ idTokenHeader() | json }}</pre>
            <h3>Payload</h3>
            <pre>{{ idTokenPayload() | json }}</pre>
          </details>
          <button type="button" (click)="forceRefreshTokenAndClaims()">Refresh Token & Claims</button>
        </div>
      </details>
    </section>

    <!-- Backend AppUser Summary -->
    <section class="profile__appuser" aria-label="Backend user details">
      <details>
        <summary><h2 class="section-title">Backend User</h2></summary>
        <ng-container *ngIf="appUser() as au; else appUserSkeleton">
          <dl aria-label="Backend user summary" class="appuser-summary">
            <div><dt>ID</dt><dd>{{ au['id'] }}</dd></div>
            <div *ngIf="au['roles']"><dt>Roles (Backend)</dt><dd>{{ au['roles'].join(', ') }}</dd></div>
            <div *ngIf="au['displayName']"><dt>Name</dt><dd>{{ au['displayName'] }}</dd></div>
            <div *ngIf="au['email']"><dt>Email</dt><dd>{{ au['email'] }}</dd></div>
          </dl>
        </ng-container>
        <ng-template #appUserSkeleton>
          <app-loading-skeleton [lines]="2"></app-loading-skeleton>
        </ng-template>
      </details>
    </section>

    <!-- Profile Data -->
    <section class="profile__data" aria-label="Profile data details">
      <details>
        <summary><h2 class="section-title">Profile Data</h2></summary>
        <!-- Editable public display name -->
        <div style="margin: 0 1.25rem 0.75rem; display:flex; align-items:flex-end; gap:0.75rem; flex-wrap:wrap;">
          <label style="display:flex; flex-direction:column; gap:0.25rem; min-width: 260px;">
            <span class="muted">Public display name</span>
            <input type="text" [formControl]="profileName" maxlength="200" placeholder="How your name appears publicly" />
          </label>
          <button type="button" (click)="saveProfileName()" [disabled]="profileSaving() || profileName.invalid">
            {{ existingProfile() ? 'Save Changes' : 'Create Profile' }}
          </button>
          <div *ngIf="profileName.touched && profileName.invalid" class="error">
            <span *ngIf="profileName.errors?.['required']">Display name is required.</span>
            <span *ngIf="profileName.errors?.['minlength']">Must be at least 2 characters.</span>
            <span *ngIf="profileName.errors?.['maxlength']">Must be 200 characters or less.</span>
          </div>
        </div>
        <ng-container *ngIf="existingProfile() as p; else profileSkeleton">
          <dl aria-label="Profile core fields" class="profile-summary">
            <div><dt>Completed</dt><dd>{{ p.completed }}</dd></div>
            <div><dt>Verified</dt><dd>{{ p.verified }}</dd></div>
          </dl>
        </ng-container>
        <ng-template #profileSkeleton>
          <app-loading-skeleton [lines]="2"></app-loading-skeleton>
        </ng-template>
      </details>
    </section>

    <!-- Events Overview -->
    <section class="profile__events" aria-label="My events list">
      <details>
        <summary><h2 class="section-title">My Events</h2></summary>
        <ng-container *ngIf="myEvents() as my; else myEventsSkeleton">
          <p *ngIf="!my.length">You have not created any events yet.</p>
          <ul *ngIf="my.length">
            <li *ngFor="let e of my">{{ e.eventName || '(untitled event)' }} (ID: {{ e.eventId }})</li>
          </ul>
          <details *ngIf="my.length">
            <summary>Raw JSON for My Events</summary>
            <div *ngFor="let e of my"><pre>{{ e | json }}</pre></div>
          </details>
        </ng-container>
        <ng-template #myEventsSkeleton>
          <app-loading-skeleton [lines]="3"></app-loading-skeleton>
        </ng-template>
      </details>
    </section>

    <!-- Dev Visibility: All Events (collapsible) -->
    <section class="profile__allevents" *ngIf="allEvents() as all" aria-label="All events developer visibility">
      <details>
        <summary><h2 class="section-title">All Events (Developer Visibility)</h2></summary>
        <p *ngIf="!all.length">No events loaded.</p>
        <ul *ngIf="all.length">
          <li *ngFor="let e of all">{{ e.eventName || '(untitled event)' }}</li>
        </ul>
        <details *ngIf="all.length">
          <summary>Raw JSON for All Events</summary>
          <div *ngFor="let e of all"><pre>{{ e | json }}</pre></div>
        </details>
      </details>
    </section>

    <!-- Admin Audits -->
    <section class="profile__audits" *ngIf="isAdmin()" aria-label="Admin event audits">
      <details>
        <summary><h2 class="section-title">Event Audits (Admin)</h2></summary>
        <div class="audit-controls" *ngIf="adminSelectableEvents() as events">
          <label>
            <span>Select Event</span>
            <select (change)="selectedEventId.set($any($event.target).value); loadAudits();">
              <option *ngFor="let e of events" [value]="e.eventId">{{ e.eventName || e.eventId }}</option>
            </select>
          </label>
          <button type="button" (click)="loadAudits()" [disabled]="auditsLoading()">Reload</button>
        </div>
        <div *ngIf="auditsLoading()"><app-loading-skeleton [lines]="2"></app-loading-skeleton></div>
        <div *ngIf="auditsError() as err" class="error">{{ err }}</div>
        <ng-container *ngIf="audits() as rows">
          <table class="audit-table" *ngIf="rows.length; else noAudits">
            <thead>
              <tr>
                <th>When</th>
                <th>Action</th>
                <th>Actor User Id</th>
                <th>Timestamp</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let a of rows">
                <td>{{ relTime(a.at) }}</td>
                <td>{{ a.action }}</td>
                <td>{{ a.actorUserId }}</td>
                <td>{{ a.at }}</td>
              </tr>
            </tbody>
          </table>
          <ng-template #noAudits>
            <p class="muted">No audit entries yet for this event.</p>
          </ng-template>
        </ng-container>
      </details>
    </section>
  </ng-container>

  <ng-template #notSignedIn>
    <p>Youâ€™re not signed in. <a routerLink="/login">Go to Login</a></p>
  </ng-template>
</section>

<ng-template #loadingTpl>
  <app-loading-skeleton [avatar]="true" [lines]="3"></app-loading-skeleton>
</ng-template>
